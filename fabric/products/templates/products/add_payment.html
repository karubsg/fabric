{% extends 'products/base.html' %}
{% load crispy_forms_tags %}

{% block title %}Ödeme Ekle - FabricCRM{% endblock %}
{% block header %}Yeni Ödeme Kaydı{% endblock %}

{% block actions %}
    <a href="{% url 'payment_list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-list-ul"></i> Tüm Ödemeler
    </a>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body p-4">
        <form method="post" novalidate class="needs-validation">
            {% csrf_token %}
            {% crispy form %}
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <a href="{% url 'payment_list' %}" class="btn btn-outline-secondary me-md-2">
                    <i class="bi bi-x-circle"></i> İptal
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> Kaydet
                </button>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Form elementi
        const form = document.querySelector('form');
        const dateInput = document.getElementById('id_date');

        // Sayfa yüklendiğinde tarihi bugüne ayarla
        if (dateInput) {
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
        }

        // Form gönderildiğinde
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Form verilerini al
            const formData = new FormData(form);
            
            // AJAX ile form verilerini gönder
            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => {
                if (response.ok) {
                    // Başarılı ise ödeme listesine yönlendir
                    window.location.href = '{% url "payment_list" %}';
                } else {
                    throw new Error('Ödeme kaydedilemedi');
                }
            })
            .catch(error => {
                console.error('Hata:', error);
                alert('Ödeme kaydedilirken bir hata oluştu!');
            });
        });
    });
</script>
{% endblock %}
{% endblock %}